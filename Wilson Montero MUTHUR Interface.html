<!-- montero_wilson.html (EDIT APPLIED: chip shade matches Miller; no other changes) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MU/TH/UR 6500 // USCSS MONTERO // WILSON</title>

  <style>
    :root{
      --bg:#000;
      --fg:#7af042;
      --fg2:#54b92f;
      --line:rgba(122,240,66,.28);
      --warn:#c9ff6a;
      --crit:#ffcc66;
      --seal:#ff7a7a;

      --pad: clamp(10px, 2.8vw, 16px);
      --radius: 12px;
      --btnMinH: 52px;

      --fontBase: clamp(15px, 3.2vw, 22px);
      --fontSmall: clamp(12px, 2.6vw, 16px);
      --fontTiny: clamp(11px, 2.2vw, 14px);

      --typeSpeed: 12; /* ms/char */
    }

    html, body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:"Share Tech Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: var(--fontBase);
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
      touch-action: manipulation;
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 50% 30%, rgba(122,240,66,.10), transparent 55%),
        linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.55)),
        repeating-linear-gradient(to bottom,
          rgba(255,255,255,.03) 0px, rgba(255,255,255,.03) 1px,
          rgba(0,0,0,0) 2px, rgba(0,0,0,0) 4px
        );
      mix-blend-mode: screen;
      opacity:.9;
    }

    #app{
      height:100%;
      display:grid;
      grid-template-rows: auto auto 1fr;
      min-width:0;
    }

    #topbar{
      padding: calc(var(--pad) + env(safe-area-inset-top)) var(--pad) var(--pad);
      border-bottom:1px solid var(--line);
      background: linear-gradient(to bottom, rgba(15,25,15,.7), rgba(0,0,0,0));
      display:grid;
      gap: 6px;
      min-width:0;
    }
    #title{
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:700;
      font-size: 1.0em;
      line-height:1.15;
      min-width:0;
    }
    #statusrow{
      display:flex;
      gap:10px;
      align-items:baseline;
      justify-content:space-between;
      min-width:0;
    }
    #statusline{
      color:var(--fg2);
      opacity:.95;
      letter-spacing:.07em;
      font-size: var(--fontSmall);
      line-height:1.2;
      flex:1;
      min-width:0;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    #clock{
      color:var(--fg2);
      opacity:.85;
      letter-spacing:.08em;
      font-size: var(--fontSmall);
      white-space:nowrap;
      flex:none;
    }

    /* ===== Categories area (collapsible) ===== */
    #catArea{
      padding: 8px var(--pad);
      border-bottom:1px solid rgba(122,240,66,.16);
      background: rgba(0,0,0,.25);
      overflow:hidden;
      min-width:0;
    }

    #catHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 0 10px 0;
      min-width:0;
    }
    #catHeader .label{
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:700;
      font-size: var(--fontSmall);
      color: var(--fg2);
      opacity:.95;
      min-width:0;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    #catToggle{
      border:1px solid rgba(122,240,66,.25);
      background: linear-gradient(180deg, rgba(12,22,12,.75), rgba(0,0,0,.35));
      color: var(--fg);
      border-radius: 999px;
      padding: 10px 12px;
      min-height: 44px;
      font-size: var(--fontTiny);
      letter-spacing:.10em;
      text-transform:uppercase;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      flex:none;
    }
    #catToggle:active{ transform: translateY(1px); }

    #catArea.is-collapsed #categories,
    #catArea.is-collapsed #categoriesRail{
      display:none !important;
    }
    #catArea.is-collapsed{ padding-bottom: 10px; }

    /* ===== Scroller wrappers + always-visible indicators ===== */
    .scrollerWrap{
      position: relative;
      min-width:0;
    }
    .scrollerWrap .gridWrap,
    .scrollerWrap .rail{
      padding-right: 14px;
    }

    .scrollIndicator{
      position:absolute;
      pointer-events:none;
      opacity:.95;
      z-index: 20;
    }
    .scrollIndicator.v{
      top: 8px;
      bottom: 8px;
      right: 2px;
      width: 10px;
      border: 1px solid rgba(122,240,66,.22);
      background: rgba(0,0,0,.25);
      border-radius: 10px;
      overflow:hidden;
    }
    .scrollIndicator.v .thumb{
      width: 100%;
      height: 22%;
      background: rgba(122,240,66,.35);
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(122,240,66,.10);
      transform: translateY(0px);
    }
    .scrollIndicator.isHidden{ opacity: 0; }

    /* Rail */
    .rail{
      display:flex;
      gap:10px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      min-width:0;
      scrollbar-width: thin;
      scrollbar-color: rgba(122,240,66,.35) rgba(0,0,0,.25);
      padding-bottom: 6px;
    }
    .rail::-webkit-scrollbar{ height: 10px; }
    .rail::-webkit-scrollbar-track{ background: rgba(0,0,0,.25); }
    .rail::-webkit-scrollbar-thumb{
      background: rgba(122,240,66,.35);
      border: 2px solid rgba(0,0,0,.25);
      border-radius: 10px;
    }

    /* 3-col grid */
    .gridWrap{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      max-height: 26vh;
      overflow-y:auto;
      overflow-x:hidden;
      min-width:0;
      scrollbar-width: thin;
      scrollbar-color: rgba(122,240,66,.35) rgba(0,0,0,.25);
      padding-right: 4px;
    }
    .gridWrap::-webkit-scrollbar{ width: 10px; }
    .gridWrap::-webkit-scrollbar-track{ background: rgba(0,0,0,.25); }
    .gridWrap::-webkit-scrollbar-thumb{
      background: rgba(122,240,66,.35);
      border: 2px solid rgba(0,0,0,.25);
      border-radius: 10px;
    }

    /* Chips (EDITED: now matches Miller exactly) */
    .chip{
      min-height: var(--btnMinH);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(12,22,12,.85), rgba(5,10,5,.55));
      color: var(--fg);
      border-radius: var(--radius);
      padding: 12px 12px;
      text-align:left;
      user-select:none;
      cursor:pointer;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
      outline:none;
      -webkit-tap-highlight-color: transparent;

      width:100%;
      min-width:0;
      box-sizing:border-box;
    }
    .chip:active{ transform: translateY(1px); }
    .chip .k, .chip .d{
      min-width:0;
      overflow-wrap:anywhere;
      word-break:break-word;
      white-space:normal;
    }
    .chip .k{
      display:block;
      font-weight:700;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size: var(--fontSmall);
      line-height:1.1;
    }
    .chip .d{
      display:block;
      margin-top: 6px;
      color: var(--fg2);
      opacity:.9;
      font-size: var(--fontTiny);
      letter-spacing:.03em;
      line-height:1.15;
    }
    .chip.active{
      border-color: rgba(122,240,66,.60);
      background: linear-gradient(180deg, rgba(16,30,16,.92), rgba(6,12,6,.65));
      box-shadow: 0 0 0 1px rgba(122,240,66,.12), 0 0 22px rgba(122,240,66,.08);
    }

    /* Workspace */
    #workspace{
      margin: var(--pad);
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(10,20,10,.55), rgba(0,0,0,.35));
      display:grid;
      grid-template-rows: auto auto 1fr;
      overflow:hidden;
      min-height:0;
      min-width:0;
    }

    #wsHeader{
      padding: 12px;
      border-bottom:1px solid rgba(122,240,66,.16);
      display:grid;
      gap:6px;
      background: rgba(0,0,0,.18);
      min-width:0;
    }
    #wsTitle{
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:700;
      font-size: var(--fontSmall);
      line-height:1.2;
      min-width:0;
    }
    #wsMeta{
      color:var(--fg2);
      opacity:.88;
      font-size: var(--fontTiny);
      letter-spacing:.06em;
      text-transform:uppercase;
      line-height:1.2;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      min-width:0;
    }

    #subArea{
      padding: 10px 12px;
      border-bottom:1px solid rgba(122,240,66,.12);
      background: rgba(0,0,0,.10);
      overflow:hidden;
      min-width:0;
    }

    #details{
      padding: 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      min-height:0;
      min-width:0;
    }

    .line{
      display:block;
      margin: 0 0 10px 0;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.25;
      font-size: var(--fontBase);
    }
    .underline{
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: 5px;
    }
    .dim{ color: var(--fg2); opacity:.9; }
    .warn{ color: var(--warn); }
    .crit{ color: var(--crit); }

    .cursor{
      display:inline-block;
      width:.55em;
      margin-left:.15em;
      background: var(--fg);
      opacity:.65;
      animation: blink 1.05s infinite steps(1);
      transform: translateY(.08em);
    }
    @keyframes blink { 50%{ opacity:0; } }

    /* Login */
    #loginOverlay{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.86);
      z-index: 9999;
      padding: var(--pad);
      padding-top: calc(var(--pad) + env(safe-area-inset-top));
      padding-bottom: calc(var(--pad) + env(safe-area-inset-bottom));
      box-sizing:border-box;
      min-width:0;
    }
    #loginCard{
      width:min(860px, 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(10,20,10,.75), rgba(0,0,0,.6));
      box-shadow: 0 0 0 1px rgba(0,0,0,.7), 0 0 40px rgba(122,240,66,.08);
      padding: 16px;
    }
    #loginCard h1{
      margin:0 0 8px 0;
      font-size:1.08em;
      letter-spacing:.18em;
      text-transform:uppercase;
    }
    #loginCard .sub{
      margin:0 0 14px 0;
      color: var(--fg2);
      opacity:.9;
      font-size: var(--fontSmall);
      letter-spacing:.08em;
      line-height:1.2;
    }

    @media (max-width: 520px){
      #categoriesRail, #subcatsRail { display:none; }
      #categories, #subcats { display:grid; }
      .gridWrap{ max-height: 28vh; }
    }
    @media (min-width: 521px){
      #categories, #subcats { display:none; }
      #categoriesRail, #subcatsRail { display:flex; }
      .rail .chip{ flex: 0 0 auto; min-width: 220px; width:auto; }
    }

    /* ===================== */
    /* Special Order 966 EDITS */
    /* ===================== */
    .chip.so966{
      border-color: rgba(122,240,66,.85);
      box-shadow: 0 0 0 1px rgba(122,240,66,.20), 0 0 18px rgba(122,240,66,.16);
      animation: so966Pulse 1.1s steps(1) infinite;
    }
    @keyframes so966Pulse{
      0%{ filter: brightness(1.0); }
      50%{ filter: brightness(1.35); }
      100%{ filter: brightness(1.0); }
    }

    .bright{ color: var(--fg); opacity:1; }
    .bright2{ color: var(--fg2); opacity:1; }
    .priority{
      color: var(--warn);
      opacity:1;
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .classified{
      letter-spacing:.10em;
      text-transform:uppercase;
      opacity:.9;
    }

    .flashBox{
      display:inline-block;
      padding: 2px 6px;
      border: 1px solid rgba(122,240,66,.85);
      border-radius: 6px;
      background: rgba(122,240,66,.10);
      animation: flashGreenBox 0.55s steps(1) infinite;
    }
    @keyframes flashGreenBox{
      0%{ background: rgba(122,240,66,.08); box-shadow:none; }
      50%{ background: rgba(122,240,66,.28); box-shadow: 0 0 16px rgba(122,240,66,.20); }
      100%{ background: rgba(122,240,66,.08); box-shadow:none; }
    }
  </style>
</head>

<body>
<div id="app">
  <div id="topbar">
    <div id="title">MU/TH/UR 6500 // USCSS MONTERO</div>
    <div id="statusrow">
      <div id="statusline">STANDBY — CRYO RECOVERY COMPLETE. ROUTE: “THE GAUNTLET” // ANCHORPOINT → SUTTER’S WORLD.</div>
      <div id="clock">--:--:--</div>
    </div>
  </div>

  <div id="catArea">
    <div id="catHeader">
      <div class="label">DATA CATEGORIES</div>
      <button id="catToggle" type="button" aria-expanded="true">HIDE</button>
    </div>

    <div class="scrollerWrap" data-scroller="cats">
      <div id="categories" class="gridWrap" aria-label="data categories grid"></div>
      <div id="categoriesRail" class="rail" aria-label="data categories rail"></div>
      <div class="scrollIndicator v"><div class="thumb"></div></div>
    </div>
  </div>

  <div id="workspace">
    <div id="wsHeader">
      <div id="wsTitle">DATA CATEGORIES</div>
      <div id="wsMeta">OPERATOR: UNAUTHENTICATED</div>
    </div>

    <div id="subArea">
      <div class="scrollerWrap" data-scroller="subs">
        <div id="subcats" class="gridWrap" aria-label="subcategories grid"></div>
        <div id="subcatsRail" class="rail" aria-label="subcategories rail"></div>
        <div class="scrollIndicator v"><div class="thumb"></div></div>
      </div>
    </div>

    <div id="details" aria-label="details output"></div>
  </div>
</div>

<div id="loginOverlay">
  <div id="loginCard">
    <h1>IDENTIFY</h1>
    <p class="sub">AUTHORIZED PERSONNEL PROFILES AVAILABLE:</p>
    <button class="chip" id="loginWilson" type="button" style="width:100%;">
      <span class="k">J. J. WILSON</span>
      <span class="d">COMPANY AGENT // CORPORATE LIAISON</span>
    </button>
    <p class="sub" style="margin-top:14px; opacity:.8;">INTERFACE INPUT: BOX-SELECTION ONLY.</p>
  </div>
</div>

<script>
  let els = {
    clock: document.getElementById("clock"),
    catArea: document.getElementById("catArea"),
    catToggle: document.getElementById("catToggle"),

    categoriesGrid: document.getElementById("categories"),
    categoriesRail: document.getElementById("categoriesRail"),

    subcatsGrid: document.getElementById("subcats"),
    subcatsRail: document.getElementById("subcatsRail"),

    details: document.getElementById("details"),
    wsTitle: document.getElementById("wsTitle"),
    wsMeta: document.getElementById("wsMeta"),

    loginOverlay: document.getElementById("loginOverlay"),
    loginWilson: document.getElementById("loginWilson")
  };

  const TYPE_SPEED = Number(getComputedStyle(document.documentElement).getPropertyValue("--typeSpeed")) || 12;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function nowClock(){
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  setInterval(()=> els.clock.textContent = nowClock(), 250);
  els.clock.textContent = nowClock();

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function typeLine(targetEl, text, opts = {}){
    const speed = Number.isFinite(opts.speed) ? opts.speed : TYPE_SPEED;
    const underline = !!opts.underline;
    const cls = opts.cls || "";
    const prefix = opts.prefix ?? `${nowClock()} [MU/TH/UR] `;
    const showPrefix = opts.showPrefix !== false;

    const line = document.createElement("span");
    line.className = `line ${underline ? "underline" : ""} ${cls}`.trim();
    targetEl.appendChild(line);

    const full = (showPrefix ? prefix : "") + text;
    const cursor = document.createElement("span");
    cursor.className = "cursor";
    cursor.textContent = " ";
    const textNode = document.createTextNode("");
    line.appendChild(textNode);
    line.appendChild(cursor);

    let out = "";
    for (let i=0; i<full.length; i++){
      out += full[i];
      textNode.textContent = out;
      await sleep(speed);
    }
    cursor.remove();
    targetEl.scrollTop = targetEl.scrollHeight;
  }

  function setCategoriesCollapsed(collapsed){
    els.catArea.classList.toggle("is-collapsed", collapsed);
    els.catToggle.textContent = collapsed ? "SHOW" : "HIDE";
    els.catToggle.setAttribute("aria-expanded", String(!collapsed));
    try { localStorage.setItem("montero_cat_collapsed", collapsed ? "1" : "0"); } catch(e){}
    refreshIndicatorsSoon();
  }

  function isPortrait(){
    return window.matchMedia("(max-width: 520px)").matches;
  }
  function getActiveScroller(which){
    if (which === "cats"){
      return isPortrait() ? els.categoriesGrid : els.categoriesRail;
    }
    return isPortrait() ? els.subcatsGrid : els.subcatsRail;
  }
  function updateIndicator(wrapper){
    const which = wrapper.dataset.scroller;
    const scroller = getActiveScroller(which);
    const ind = wrapper.querySelector(".scrollIndicator.v");
    const thumb = ind.querySelector(".thumb");

    if (!scroller || scroller.offsetParent === null){
      ind.classList.add("isHidden");
      return;
    }

    const isRail = scroller.classList.contains("rail");
    if (isRail){
      ind.classList.add("isHidden");
      return;
    }

    const scrollH = scroller.scrollHeight;
    const clientH = scroller.clientHeight;
    const maxScroll = Math.max(0, scrollH - clientH);

    if (maxScroll <= 1){
      ind.classList.add("isHidden");
      return;
    }
    ind.classList.remove("isHidden");

    const ratio = clientH / scrollH;
    const thumbH = Math.max(12, Math.floor(ratio * clientH));
    thumb.style.height = thumbH + "px";

    const travel = Math.max(0, clientH - thumbH);
    const y = (scroller.scrollTop / maxScroll) * travel;
    thumb.style.transform = `translateY(${y}px)`;
  }
  function bindIndicator(wrapper){
    const which = wrapper.dataset.scroller;
    const attach = ()=>{
      const scroller = getActiveScroller(which);
      if (!scroller) return;
      scroller.addEventListener("scroll", ()=>updateIndicator(wrapper), {passive:true});
      updateIndicator(wrapper);
    };
    attach();
  }
  function refreshIndicators(){
    document.querySelectorAll(".scrollerWrap").forEach(updateIndicator);
  }
  function refreshIndicatorsSoon(){
    requestAnimationFrame(refreshIndicators);
    setTimeout(refreshIndicators, 80);
  }
  window.addEventListener("resize", refreshIndicatorsSoon, {passive:true});
  window.addEventListener("orientationchange", refreshIndicatorsSoon, {passive:true});

  /* ===== Wilson KB ===== */
  const KB = {
    operator: { name:"John J. Wilson", role:"Company Agent", access:"ELEVATED" },
    ship: { systems: {
      vessel: ["HULL: INTEGRITY NOMINAL. MICROFRACTURE MAP: STABLE.","THERMAL: GREEN-ZONE AVERAGE. LOCALIZED HOTSPOTS: NONE.","GRAV: 1.0G SETPOINT. VARIANCE: ±0.02G."],
      propulsion: ["SATURN J 3000 THRUSTERS: READY.","DISPLACEMENT DRIVE: STANDBY (FTL CAPABLE).","COMMERCIAL TOW INTERFACE: NOT INSTALLED."],
      lifeSupport: ["O2 SCRUBBING: NOMINAL.","CO2: WITHIN LIMITS.","CRYO DECK: RECOVERY COMPLETE. PODS: 5/5 ONLINE."],
      power: ["PRIMARY BUS: STABLE.","AUX BUS: STABLE.","REACTOR: WITHIN OUTPUT ENVELOPE."],
      comms: ["COMMS ARRAY: NOMINAL.","ENCRYPTION: CORPORATE CHANNELS AVAILABLE (CLEARANCE-BASED)."],
      sensors: ["SENSORS: PARTIAL ANOMALY HISTORY — INTERMITTENT REFLECTION PINGS PRIOR TO FTL.","RESOLUTION: STANDARD CARGO HAULER GRADE."]
    }},
    cargo: { summary: ["BAY LOAD: 72 HIGH-PRESSURE TANKS.","CONTENTS: 200,000 TONS AGING TRITIUM GAS (DECAYING INTO HELIUM-3).","HAZARD: VOLATILE/FLAMMABLE — EXTREME CAUTION ADVISED.","DELIVERY: SUTTER’S WORLD (WEYLAND-YUTANI CORPORATE ACCOUNT)."] },
    corporate: {
      notice: [
        "CORPORATE CHANNEL: WEYLAND-YUTANI COMCON 01500.",
        "AUTHORIZATION: AGENT WILSON // 942/T2-009R.",
        "STATUS: DIRECTIVE ACTIVE."
      ],
      blackLevel: [
        "BLACK-LEVEL ADDENDUM (RESTRICTED):",
        "MU/TH/UR 6500 AUTHORIZED TO EXECUTE DIRECTIVE COMPLIANCE WITHOUT CREW CONSENT.",
        "FAILSAFE OPTIONS MAY INCLUDE ASSET DENIAL AND/OR VESSEL TERMINATION IF OBJECTIVES COMPROMISED."
      ]
    }
  };

  function so966Lines(){
    return [
      { t: "TO: USCSS MONTERO - AGENT WILSON, JOHN J - 942/T2-009R", underline:true,  cls:"bright" },
      { t: "FROM NETWORK", underline:false,  cls:"bright" },
      { t: "NEW DIRECTIVE — SPECIAL ORDER 966", underline:false,  cls:"bright" },
      { t: "STANDARD DIRECTIVE PROTOCOL ACTIVE", underline:false, cls:"bright" },
      { t: "QUARANTINE SCIENCE TEAM", underline:false, cls:"bright" },
      { t: "DIRECT CREW TO REPAIR AND RETURN USCSS CRONUS", underline:false, cls:"bright" },
      { t: "USE OF FORCE AUTHORIZED", underline:false, cls:"bright" },
      { t: "REMOVE MONTERO FROM EQUATION", underline:false, cls:"bright", special:"remove" },
      { t: "TRANSFER CREW TO SCIENCE VESSEL", underline:false, cls:"bright" },
      { t: "REPEAT — DO NOT ABANDON CRONUS", underline:false, cls:"bright" },
      { t: "BRING BACK ALL XENOMORPHIC MATERIALS", underline:false, cls:"bright" },
      { t: "PRIORITY ONE", underline:false, cls:"priority" },
      { t: "ALL OTHER PRIORITIES RESCINDED", underline:true,  cls:"bright" },
      { t: "ADDITIONAL DATA CLASSIFIED", underline:false, cls:"bright2 classified" }
    ];
  }

  const DATA_MODEL = [
    { id:"so966cat", label:"SPECIAL ORDER 966", desc:"DIRECTIVE // NETWORK", chipClass:"so966",
      subs:[ { id:"so966msg", label:"SPECIAL ORDER 966", get:()=>so966Lines() } ]
    },
    { id:"system", label:"SYSTEM STATUS", desc:"VESSEL / PROP / LIFE / POWER / COMMS / SENSORS",
      subs:[
        { id:"vessel", label:"VESSEL", get:()=>KB.ship.systems.vessel },
        { id:"prop", label:"PROPULSION", get:()=>KB.ship.systems.propulsion },
        { id:"life", label:"LIFE SUPPORT", get:()=>KB.ship.systems.lifeSupport },
        { id:"power", label:"POWER", get:()=>KB.ship.systems.power },
        { id:"comms", label:"COMMS", get:()=>KB.ship.systems.comms },
        { id:"sensors", label:"SENSORS", get:()=>KB.ship.systems.sensors },
      ]
    },
    { id:"cargo", label:"CARGO MANIFEST", desc:"TANKAGE / DELIVERY",
      subs:[ { id:"summary", label:"PRIMARY CARGO", get:()=>KB.cargo.summary } ]
    },
    { id:"corp", label:"CORPORATE DATA", desc:"COMCON / CHANNEL",
      subs:[ { id:"notice", label:"CHANNEL NOTICE", get:()=>KB.corporate.notice } ]
    },
    { id:"black", label:"BLACK-LEVEL DATA", desc:"RESTRICTED",
      subs:[ { id:"add", label:"BLACK-LEVEL ADDENDUM", get:()=>KB.corporate.blackLevel } ]
    }
  ];

  function makeChip({id, title, desc, chipClass}, onClick){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "chip" + (chipClass ? (" " + chipClass) : "");
    b.dataset.id = id;
    b.innerHTML = `<span class="k">${title}</span><span class="d">${desc || "SELECT"}</span>`;
    b.addEventListener("click", onClick, {passive:true});
    return b;
  }

  function clearForNewCategory(){
    els.subcatsGrid.innerHTML = "";
    els.subcatsRail.innerHTML = "";
    els.details.innerHTML = "";
    els.details.scrollTop = 0;
    refreshIndicatorsSoon();
  }

  function setActiveCategory(catId){
    const all = [
      ...els.categoriesGrid.querySelectorAll(".chip"),
      ...els.categoriesRail.querySelectorAll(".chip")
    ];
    all.forEach(btn => btn.classList.toggle("active", btn.dataset.id === catId));
  }

  function setActiveSub(subId){
    const all = [
      ...els.subcatsGrid.querySelectorAll(".chip"),
      ...els.subcatsRail.querySelectorAll(".chip")
    ];
    all.forEach(btn => btn.classList.toggle("active", btn.dataset.id === subId));
  }

  function renderCategories(){
    els.categoriesGrid.innerHTML = "";
    els.categoriesRail.innerHTML = "";
    for (const c of DATA_MODEL){
      els.categoriesGrid.appendChild(makeChip(
        {id:c.id, title:c.label, desc:c.desc, chipClass:c.chipClass},
        ()=>selectCategory(c.id)
      ));
      els.categoriesRail.appendChild(makeChip(
        {id:c.id, title:c.label, desc:c.desc, chipClass:c.chipClass},
        ()=>selectCategory(c.id)
      ));
    }
    refreshIndicatorsSoon();
  }

  async function selectCategory(catId){
    const cat = DATA_MODEL.find(c=>c.id===catId);
    if (!cat) return;

    setActiveCategory(catId);
    clearForNewCategory();

    els.wsTitle.textContent = cat.label;
    els.wsMeta.textContent = `OPERATOR: ${KB.operator.name.toUpperCase()} // ROLE: ${KB.operator.role.toUpperCase()} // ACCESS: ${KB.operator.access}`;

    if (catId === "so966cat"){
      els.subcatsGrid.innerHTML = "";
      els.subcatsRail.innerHTML = "";
      refreshIndicatorsSoon();
      await renderSpecialOrder966();
      return;
    }

    for (const s of cat.subs){
      els.subcatsGrid.appendChild(makeChip({id:s.id, title:s.label, desc:"SELECT TO DISPLAY"}, ()=>selectSub(cat, s)));
      els.subcatsRail.appendChild(makeChip({id:s.id, title:s.label, desc:"SELECT TO DISPLAY"}, ()=>selectSub(cat, s)));
    }

    refreshIndicatorsSoon();
    await typeLine(els.details, "CATEGORY READY. SELECT A SUBCATEGORY.", { underline:true, cls:"dim" });
  }

  async function renderSpecialOrder966(){
    els.details.innerHTML = "";
    await typeLine(els.details, "SPECIAL ORDER 966", { underline:true, cls:"bright" });

    const lines = so966Lines();
    for (const item of lines){
      if (item.special === "remove"){
        const line = document.createElement("span");
        line.className = `line ${item.underline ? "underline" : ""} ${item.cls || ""}`.trim();
        els.details.appendChild(line);

        const prefix = `${nowClock()} [MU/TH/UR] `;
        const prefixNode = document.createTextNode("");
        line.appendChild(prefixNode);

        const box = document.createElement("span");
        box.className = "flashBox";
        line.appendChild(box);

        let out = "";
        for (let i=0; i<prefix.length; i++){
          out += prefix[i];
          prefixNode.textContent = out;
          await sleep(TYPE_SPEED);
        }
        let bOut = "";
        for (let i=0; i<item.t.length; i++){
          bOut += item.t[i];
          box.textContent = bOut;
          await sleep(TYPE_SPEED);
        }
        els.details.scrollTop = els.details.scrollHeight;
        continue;
      }

      await typeLine(els.details, item.t, { underline: !!item.underline, cls: item.cls || "" });
    }
  }

  async function selectSub(cat, sub){
    setActiveSub(sub.id);
    els.details.innerHTML = "";

    await typeLine(els.details, `${cat.label} / ${sub.label}`, { underline:true });

    const payload = sub.get ? sub.get() : [];
    const lines = Array.isArray(payload) ? payload : [];

    for (const item of lines){
      if (typeof item === "string"){
        const cls =
          /^WARNING|HAZARD|ADVISORY|OPSEC/.test(item) ? "warn" :
          /^CRITICAL|FAILSAFE/.test(item) ? "crit" : "";
        await typeLine(els.details, item, { cls });
        continue;
      }

      if (item && typeof item === "object"){
        if (item.special === "remove"){
          const line = document.createElement("span");
          line.className = `line ${item.underline ? "underline" : ""} ${item.cls || ""}`.trim();
          els.details.appendChild(line);

          const prefix = `${nowClock()} [MU/TH/UR] `;
          const prefixNode = document.createTextNode("");
          line.appendChild(prefixNode);

          const box = document.createElement("span");
          box.className = "flashBox";
          line.appendChild(box);

          let out = "";
          for (let i=0; i<prefix.length; i++){
            out += prefix[i];
            prefixNode.textContent = out;
            await sleep(TYPE_SPEED);
          }
          let bOut = "";
          for (let i=0; i<(item.t||"").length; i++){
            bOut += item.t[i];
            box.textContent = bOut;
            await sleep(TYPE_SPEED);
          }

          els.details.scrollTop = els.details.scrollHeight;
          continue;
        }

        await typeLine(els.details, item.t || "", {
          underline: !!item.underline,
          cls: item.cls || ""
        });
      }
    }
  }

  els.catToggle.addEventListener("click", ()=>{
    const collapsed = els.catArea.classList.contains("is-collapsed");
    setCategoriesCollapsed(!collapsed);
  });

  try{
    const v = localStorage.getItem("montero_cat_collapsed");
    if (v === "1") setCategoriesCollapsed(true);
  }catch(e){}

  document.querySelectorAll(".scrollerWrap").forEach(bindIndicator);

  els.loginWilson.addEventListener("click", async ()=>{
    els.loginOverlay.style.display = "none";
    renderCategories();

    els.details.innerHTML = "";
    els.wsMeta.textContent = `OPERATOR: ${KB.operator.name.toUpperCase()} // ROLE: ${KB.operator.role.toUpperCase()} // ACCESS: ${KB.operator.access}`;

    await typeLine(els.details, "CONNECTION ESTABLISHED.");
    await typeLine(els.details, "SYSTEM: MU/TH/UR 6500 ONLINE.");
    await typeLine(els.details, "OPERATOR PROFILE LOADED: WILSON, J. J. — COMPANY AGENT.", { underline:true });
    await typeLine(els.details, "ELEVATED ACCESS ENABLED.", { cls:"warn" });
    await typeLine(els.details, "SELECT A DATA CATEGORY ABOVE.", { cls:"dim" });

    refreshIndicatorsSoon();
  });
</script>
</body>
</html>
